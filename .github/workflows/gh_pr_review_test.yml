name: 'gh_pr_review'

on:
  pull_request:
    types: [ review_requested ]
  pull_request_review:
    types: [ submitted ]

jobs:
  review_notification:
    if: github.event.action == 'review_requested' && github.event.requested_reviewer.type == 'User'
    runs-on: ubuntu-latest
    steps:
    - name: Notice
      uses: actions/github-script@v6.3.3
      env:
        MESSAGE: |
          [${{ github.event.sender.login }}](https://github.com/${{ github.event.sender.login }}) requested your review on [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) pull request.
          > ${{ github.event.pull_request.title }}
          > [${{ github.event.pull_request.html_url }}](${{ github.event.pull_request.html_url }})
          > [%s changed files](${{ github.event.pull_request.html_url }}/files) with <font color="info">%s additions</font> and <font color="warning">%s deletions</font>
        WECHAT_WORK_CHAT_ID: ${{ secrets.WECHAT_WORK_CHAT_ID }}
        WECHAT_WORK_REQ: POST ${{ secrets.WECHAT_WORK_BOT_WEBHOOK }}
      with:
        script: |
          const { format } = require("util");

          const chatid = JSON.parse(process.env.WECHAT_WORK_CHAT_ID)["${{ github.event.requested_reviewer.login }}"];
          if (!chatid) {
            console.log("The reviewer ${{ github.event.requested_reviewer.login }} not found in secrets.WECHAT_WORK_CHAT_ID");
            return;
          }

          await github.request(process.env.WECHAT_WORK_REQ, {
            headers: {
              "content-type": "application/json"
            },
            data: {
              msgtype: "markdown",
              markdown: {
                content: format(process.env.MESSAGE, (${{ github.event.pull_request.changed_files }}).toLocaleString(), (${{ github.event.pull_request.additions }}).toLocaleString(), (${{ github.event.pull_request.deletions }}).toLocaleString()),
                attachments: [{
                  callback_id: "review",
                  actions: [{
                    name: "review_btn",
                    text: "Mark as Reviewed",
                    type: "button",
                    value: "Mark as Reviewed",
                    replace_text: "Already reviewed",
                    border_color: "2c974b",
                    text_color: "2c974b"
                  }, {
                    name: "ignore_btn",
                    text: "Mark as Ignored",
                    type: "button",
                    value: "Mark as Ignored",
                    replace_text: "Already ignored",
                    border_color: "6e7781",
                    text_color: "6e7781"
                  }]
                }],
                chatid
              }
            }
          });

  request_change_notification:
    if: github.event.action == 'submitted' && github.event.review.state == 'changes_requested'
    permissions:
      actions: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Comment
      uses: peter-evans/create-or-update-comment@v2.1.0
      env:
        MESSAGE: |
          Our reviewer @${{ github.event.review.user.login }} requested changes in PR.
          **Please Click the `Re-request review` button in the _Reviewers panel_ in the upper right corner(as shown below) when you have finished the changes**, and we will review it asap.
          ![reviewers pannel](https://user-images.githubusercontent.com/1575008/205927193-2a2f41c3-5aeb-4f39-96cd-8020cfe2da1c.png)
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: ${{ env.MESSAGE }}